angular.module("angular-img-cropper",[]).directive("imageCropper",["$document","$window","imageCropperDataShare",function(e,t,n){return{scope:{image:"=",croppedImage:"=",cropWidth:"=",cropHeight:"=",keepAspect:"=",touchRadius:"=",cropAreaBounds:"=",minWidth:"=",minHeight:"="},restrict:"A",link:function(e,t,r){function v(n,r){if(i&&n===r)return;var s=t[0],o=e.cropWidth,u=e.cropHeight,a=e.keepAspect,f=e.touchRadius,l=i&&i.srcImage;i=new d(s,s.width/2-o/2,s.height/2-u/2,o,u,a,f),$(s).data("crop.angular-img-cropper",i),l?i.setImage(l):m(e.image)}function m(t){if(!t)return;var n=new Image;r.cors!==undefined&&r.cors!=="no"&&(n.crossOrigin="Anonymous"),n.addEventListener("load",function(){i.setImage(n),e.$apply()},!1),n.src=t}var i,s=s||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);r.prototype=t.prototype,e.prototype=new r},o=function(){function e(e,t,n){this.over=!1,this.drag=!1,this.position=new h(e,t),this.offset=new h(0,0),this.radius=n}return e.prototype.setDrag=function(e){this.drag=e,this.setOver(e)},e.prototype.draw=function(e){},e.prototype.setOver=function(e){this.over=e},e.prototype.touchInBounds=function(e,t){return e>this.position.x-this.radius&&e<this.position.x+this.radius&&t>this.position.y-this.radius&&t<this.position.y+this.radius},e.prototype.getPosition=function(){return this.position},e.prototype.setPosition=function(e,t){this.position.x=e,this.position.y=t},e}(),u=function(){function e(t){this.borrowed=0,e.instance=this;var n=null;for(var r=0;r<t;r++)if(r===0)this.firstAvailable=new h,n=this.firstAvailable;else{var i=new h;n.setNext(i),n=i}}return e.prototype.borrow=function(e,t){if(this.firstAvailable==null)throw"Pool exhausted";this.borrowed++;var n=this.firstAvailable;return this.firstAvailable=n.getNext(),n.x=e,n.y=t,n},e.prototype.returnPoint=function(e){this.borrowed--,e.x=0,e.y=0,e.setNext(this.firstAvailable),this.firstAvailable=e},e}(),a=function(){function e(){}return e.init=function(e){this.canvas=e,this.ctx=this.canvas.getContext("2d")},e.DEG2RAD=.0174532925,e}(),f=function(e){function t(t,n,r){e.call(this,t,n,r),this.iconPoints=new Array,this.scaledIconPoints=new Array,this.getDragIconPoints(this.iconPoints,1),this.getDragIconPoints(this.scaledIconPoints,1.2)}return s(t,e),t.prototype.draw=function(e){this.over||this.drag?this.drawIcon(e,this.scaledIconPoints):this.drawIcon(e,this.iconPoints)},t.prototype.getDragIconPoints=function(e,t){var n=17*t,r=14*t,i=8*t,s=4*t;e.push(u.instance.borrow(-s/2,n-i)),e.push(u.instance.borrow(-r/2,n-i)),e.push(u.instance.borrow(0,n)),e.push(u.instance.borrow(r/2,n-i)),e.push(u.instance.borrow(s/2,n-i)),e.push(u.instance.borrow(s/2,s/2)),e.push(u.instance.borrow(n-i,s/2)),e.push(u.instance.borrow(n-i,r/2)),e.push(u.instance.borrow(n,0)),e.push(u.instance.borrow(n-i,-r/2)),e.push(u.instance.borrow(n-i,-s/2)),e.push(u.instance.borrow(s/2,-s/2)),e.push(u.instance.borrow(s/2,-n+i)),e.push(u.instance.borrow(r/2,-n+i)),e.push(u.instance.borrow(0,-n)),e.push(u.instance.borrow(-r/2,-n+i)),e.push(u.instance.borrow(-s/2,-n+i)),e.push(u.instance.borrow(-s/2,-s/2)),e.push(u.instance.borrow(-n+i,-s/2)),e.push(u.instance.borrow(-n+i,-r/2)),e.push(u.instance.borrow(-n,0)),e.push(u.instance.borrow(-n+i,r/2)),e.push(u.instance.borrow(-n+i,s/2)),e.push(u.instance.borrow(-s/2,s/2))},t.prototype.drawIcon=function(e,t){e.beginPath(),e.moveTo(t[0].x+this.position.x,t[0].y+this.position.y);for(var n=0;n<t.length;n++){var r=t[n];e.lineTo(r.x+this.position.x,r.y+this.position.y)}e.closePath(),e.fillStyle="rgba(255,228,0,1)",e.fill()},t.prototype.recalculatePosition=function(e){var t=e.getCentre();this.setPosition(t.x,t.y),u.instance.returnPoint(t)},t}(o),l=function(e){function t(t,n,r){e.call(this,t,n,r)}return s(t,e),t.prototype.drawCornerBorder=function(e){var t=10;if(this.over||this.drag)t=12;var n=1,r=1;this.horizontalNeighbour.position.x<this.position.x&&(n=-1),this.verticalNeighbour.position.y<this.position.y&&(r=-1),e.beginPath(),e.lineJoin="miter",e.moveTo(this.position.x,this.position.y),e.lineTo(this.position.x+t*n,this.position.y),e.lineTo(this.position.x+t*n,this.position.y+t*r),e.lineTo(this.position.x,this.position.y+t*r),e.lineTo(this.position.x,this.position.y),e.closePath(),e.lineWidth=2,e.strokeStyle="rgba(255,228,0,1)",e.stroke()},t.prototype.drawCornerFill=function(e){var t=10;if(this.over||this.drag)t=12;var n=1,r=1;this.horizontalNeighbour.position.x<this.position.x&&(n=-1),this.verticalNeighbour.position.y<this.position.y&&(r=-1),e.beginPath(),e.moveTo(this.position.x,this.position.y),e.lineTo(this.position.x+t*n,this.position.y),e.lineTo(this.position.x+t*n,this.position.y+t*r),e.lineTo(this.position.x,this.position.y+t*r),e.lineTo(this.position.x,this.position.y),e.closePath(),e.fillStyle="rgba(0,0,0,1)",e.fill()},t.prototype.moveX=function(e){this.setPosition(e,this.position.y)},t.prototype.moveY=function(e){this.setPosition(this.position.x,e)},t.prototype.move=function(e,t){this.setPosition(e,t),this.verticalNeighbour.moveX(e),this.horizontalNeighbour.moveY(t)},t.prototype.addHorizontalNeighbour=function(e){this.horizontalNeighbour=e},t.prototype.addVerticalNeighbour=function(e){this.verticalNeighbour=e},t.prototype.getHorizontalNeighbour=function(){return this.horizontalNeighbour},t.prototype.getVerticalNeighbour=function(){return this.verticalNeighbour},t.prototype.draw=function(e){this.drawCornerFill(e),this.drawCornerBorder(e)},t}(o),c=function(){function e(e,t,n,r){e===void 0&&(e=0),t===void 0&&(t=0),n===void 0&&(n=0),r===void 0&&(r=0),this.left=e,this.right=e+n,this.top=t,this.bottom=t+r}return e.prototype.getWidth=function(){return this.right-this.left},e.prototype.getHeight=function(){return this.bottom-this.top},e.prototype.getCentre=function(){var e=this.getWidth(),t=this.getHeight();return u.instance.borrow(this.left+e/2,this.top+t/2)},e}(),h=function(){function e(e,t){e===void 0&&(e=0),t===void 0&&(t=0),this.x=e,this.y=t}return e.prototype.setNext=function(e){this.next=e},e.prototype.getNext=function(){return this.next},e}(),p=function(){function e(e,t,n){e===void 0&&(e=0),t===void 0&&(t=0),n===void 0&&(n=0),this.id=0,this.x=e,this.y=t,this.id=n}return e}(),d=function(){function t(e,t,n,r,i,s,o){t===void 0&&(t=0),n===void 0&&(n=0),r===void 0&&(r=100),i===void 0&&(i=50),s===void 0&&(s=!0),o===void 0&&(o=20),this.keepAspect=!1,this.aspectRatio=0,this.currentDragTouches=new Array,this.isMouseDown=!1,this.ratioW=1,this.ratioH=1,this.fileType="jpeg",this.imageSet=!1,this.pointPool=new u(200),a.init(e),this.buffer=document.createElement("canvas"),this.cropCanvas=document.createElement("canvas"),this.buffer.width=e.width,this.buffer.height=e.height,this.tl=new l(t,n,o),this.tr=new l(t+r,n,o),this.bl=new l(t,n+i,o),this.br=new l(t+r,n+i,o),this.tl.addHorizontalNeighbour(this.tr),this.tl.addVerticalNeighbour(this.bl),this.tr.addHorizontalNeighbour(this.tl),this.tr.addVerticalNeighbour(this.br),this.bl.addHorizontalNeighbour(this.br),this.bl.addVerticalNeighbour(this.tl),this.br.addHorizontalNeighbour(this.bl),this.br.addVerticalNeighbour(this.tr),this.markers=[this.tl,this.tr,this.bl,this.br],this.center=new f(t+r/2,n+i/2,o),this.canvas=e,this.ctx=this.canvas.getContext("2d"),this.keepAspect=s,this.aspectRatio=i/r,this.draw(this.ctx),this.croppedImage=new Image,this.currentlyInteracting=!1,angular.element(window).off("mousemove.angular-img-cropper mouseup.angular-img-cropper touchmove.angular-img-cropper touchend.angular-img-cropper").on("mousemove.angular-img-cropper",this.onMouseMove.bind(this)).on("mouseup.angular-img-cropper",this.onMouseUp.bind(this)).on("touchmove.angular-img-cropper",this.onTouchMove.bind(this)).on("touchend.angular-img-cropper",this.onTouchEnd.bind(this)),angular.element(e).off("mousedown.angular-img-cropper touchstart.angular-img-cropper").on("mousedown.angular-img-cropper",this.onMouseDown.bind(this)).on("touchstart.angular-img-cropper",this.onTouchStart.bind(this))}return t.prototype.resizeCanvas=function(e,t){this.canvas.width=e,this.canvas.height=t,this.buffer.width=e,this.buffer.height=t,this.draw(this.ctx)},t.prototype.draw=function(e){var t=this.getBounds();if(this.srcImage){e.clearRect(0,0,this.canvasWidth,this.canvasHeight);var n=this.srcImage.height/this.srcImage.width,r=this.canvasHeight/this.canvasWidth,i=this.canvasWidth,s=this.canvasHeight;r>n?(i=this.canvasWidth,s=this.canvasWidth*n):(s=this.canvasHeight,i=this.canvasHeight/n),this.ratioW=i/this.srcImage.width,this.ratioH=s/this.srcImage.height,r<n?this.drawImageIOSFix(e,this.srcImage,0,0,this.srcImage.width,this.srcImage.height,this.buffer.width/2-i/2,0,i,s):this.drawImageIOSFix(e,this.srcImage,0,0,this.srcImage.width,this.srcImage.height,0,this.buffer.height/2-s/2,i,s),this.buffer.getContext("2d").drawImage(this.canvas,0,0,this.canvasWidth,this.canvasHeight),e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(0,0,this.canvasWidth,this.canvasHeight),e.drawImage(this.buffer,t.left,t.top,Math.max(t.getWidth(),1),Math.max(t.getHeight(),1),t.left,t.top,t.getWidth(),t.getHeight());var o;for(var u=0;u<this.markers.length;u++)o=this.markers[u],o.draw(e);this.center.draw(e),e.lineWidth=2,e.strokeStyle="rgba(255,228,0,1)",e.strokeRect(t.left,t.top,t.getWidth(),t.getHeight())}else e.fillStyle="rgba(192,192,192,1)",e.fillRect(0,0,this.canvas.width,this.canvas.height)},t.prototype.dragCrop=function(t,n,r){var i=this.getBounds(),s=t-i.getWidth()/2,o=t+i.getWidth()/2,u=n-i.getHeight()/2,a=n+i.getHeight()/2;o>=this.maxXClamp&&(t=this.maxXClamp-i.getWidth()/2),s<=this.minXClamp&&(t=i.getWidth()/2+this.minXClamp),u<this.minYClamp&&(n=i.getHeight()/2+this.minYClamp),a>=this.maxYClamp&&(n=this.maxYClamp-i.getHeight()/2),this.tl.moveX(t-i.getWidth()/2),this.tl.moveY(n-i.getHeight()/2),this.tr.moveX(t+i.getWidth()/2),this.tr.moveY(n-i.getHeight()/2),this.bl.moveX(t-i.getWidth()/2),this.bl.moveY(n+i.getHeight()/2),this.br.moveX(t+i.getWidth()/2),this.br.moveY(n+i.getHeight()/2),r.setPosition(t,n),e.cropAreaBounds&&this.imageSet&&(e.cropAreaBounds=this.getCropBounds(),e.$apply())},t.prototype.enforceMinSize=function(t,n,r){var i=t-r.getHorizontalNeighbour().getPosition().x,s=n-r.getVerticalNeighbour().getPosition().y,o=e.minWidth-Math.abs(i),a=e.minHeight-Math.abs(s);if(i==0||s==0)return t=r.getPosition().x,n=r.getPosition().y,u.instance.borrow(t,n);e.keepAspect?o>0&&a/this.aspectRatio>0?o>a/this.aspectRatio?i<0?(t-=o,s<0?n-=o*this.aspectRatio:n+=o*this.aspectRatio):(t+=o,s<0?n-=o*this.aspectRatio:n+=o*this.aspectRatio):s<0?(n-=a,i<0?t-=a/this.aspectRatio:t+=a/this.aspectRatio):(n+=a,i<0?t-=a/this.aspectRatio:t+=a/this.aspectRatio):o>0?i<0?(t-=o,s<0?n-=o*this.aspectRatio:n+=o*this.aspectRatio):(t+=o,s<0?n-=o*this.aspectRatio:n+=o*this.aspectRatio):a>0&&(s<0?(n-=a,i<0?t-=a/this.aspectRatio:t+=a/this.aspectRatio):(n+=a,i<0?t-=a/this.aspectRatio:t+=a/this.aspectRatio)):(o>0&&(i<0?t-=o:t+=o),a>0&&(s<0?n-=a:n+=a));if(t<this.minXClamp||t>this.maxXClamp||n<this.minYClamp||n>this.maxYClamp)t=r.getPosition().x,n=r.getPosition().y;return u.instance.borrow(t,n)},t.prototype.dragCorner=function(t,n,r){var i=0,s=0,o=0,a=0,f=0,l=0,c=0,h=0,p,d=0;if(e.keepAspect){p=r.getHorizontalNeighbour().getVerticalNeighbour(),o=p.getPosition().x,a=p.getPosition().y;if(t<=p.getPosition().x)if(n<=p.getPosition().y){i=o-100/this.aspectRatio,s=a-100/this.aspectRatio*this.aspectRatio,d=this.getSide(u.instance.borrow(i,s),p.getPosition(),u.instance.borrow(t,n));if(d>0){f=Math.abs(p.getPosition().y-n),l=f/this.aspectRatio,c=p.getPosition().y-f,h=p.getPosition().x-l;var v=this.enforceMinSize(h,c,r);r.move(v.x,v.y),u.instance.returnPoint(v)}else if(d<0){l=Math.abs(p.getPosition().x-t),f=l*this.aspectRatio,c=p.getPosition().y-f,h=p.getPosition().x-l;var v=this.enforceMinSize(h,c,r);r.move(v.x,v.y),u.instance.returnPoint(v)}}else{i=o-100/this.aspectRatio,s=a+100/this.aspectRatio*this.aspectRatio,d=this.getSide(u.instance.borrow(i,s),p.getPosition(),u.instance.borrow(t,n));if(d>0){l=Math.abs(p.getPosition().x-t),f=l*this.aspectRatio,c=p.getPosition().y+f,h=p.getPosition().x-l;var v=this.enforceMinSize(h,c,r);r.move(v.x,v.y),u.instance.returnPoint(v)}else if(d<0){f=Math.abs(p.getPosition().y-n),l=f/this.aspectRatio,c=p.getPosition().y+f,h=p.getPosition().x-l;var v=this.enforceMinSize(h,c,r);r.move(v.x,v.y),u.instance.returnPoint(v)}}else if(n<=p.getPosition().y){i=o+100/this.aspectRatio,s=a-100/this.aspectRatio*this.aspectRatio,d=this.getSide(u.instance.borrow(i,s),p.getPosition(),u.instance.borrow(t,n));if(d<0){f=Math.abs(p.getPosition().y-n),l=f/this.aspectRatio,c=p.getPosition().y-f,h=p.getPosition().x+l;var v=this.enforceMinSize(h,c,r);r.move(v.x,v.y),u.instance.returnPoint(v)}else if(d>0){l=Math.abs(p.getPosition().x-t),f=l*this.aspectRatio,c=p.getPosition().y-f,h=p.getPosition().x+l;var v=this.enforceMinSize(h,c,r);r.move(v.x,v.y),u.instance.returnPoint(v)}}else{i=o+100/this.aspectRatio,s=a+100/this.aspectRatio*this.aspectRatio,d=this.getSide(u.instance.borrow(i,s),p.getPosition(),u.instance.borrow(t,n));if(d<0){l=Math.abs(p.getPosition().x-t),f=l*this.aspectRatio,c=p.getPosition().y+f,h=p.getPosition().x+l;var v=this.enforceMinSize(h,c,r);r.move(v.x,v.y),u.instance.returnPoint(v)}else if(d>0){f=Math.abs(p.getPosition().y-n),l=f/this.aspectRatio,c=p.getPosition().y+f,h=p.getPosition().x+l;var v=this.enforceMinSize(h,c,r);r.move(v.x,v.y),u.instance.returnPoint(v)}}}else{var v=this.enforceMinSize(t,n,r);r.move(v.x,v.y),u.instance.returnPoint(v)}this.center.recalculatePosition(this.getBounds()),e.cropAreaBounds&&this.imageSet&&(e.cropAreaBounds=this.getCropBounds(),e.$apply())},t.prototype.getSide=function(e,t,n){var r=this.sign((t.x-e.x)*(n.y-e.y)-(t.y-e.y)*(n.x-e.x));return u.instance.returnPoint(e),u.instance.returnPoint(n),r},t.prototype.sign=function(e){return+e===e?e===0?e:e>0?1:-1:NaN},t.prototype.handleRelease=function(e){if(e==null)return;var t=0;for(var n=0;n<this.currentDragTouches.length;n++)e.id==this.currentDragTouches[n].id&&(this.currentDragTouches[n].dragHandle.setDrag(!1),e.dragHandle=null,t=n);this.currentDragTouches.splice(t,1),this.draw(this.ctx)},t.prototype.handleMove=function(e){var t=!1;for(var r=0;r<this.currentDragTouches.length;r++)if(e.id==this.currentDragTouches[r].id&&this.currentDragTouches[r].dragHandle!=null){var i=this.currentDragTouches[r],s=this.clampPosition(e.x-i.dragHandle.offset.x,e.y-i.dragHandle.offset.y);e.x=s.x,e.y=s.y,u.instance.returnPoint(s),i.dragHandle instanceof l?this.dragCorner(e.x,e.y,i.dragHandle):this.dragCrop(e.x,e.y,i.dragHandle),this.currentlyInteracting=!0,t=!0,n.setPressed(this.canvas);break}if(!t){for(var o=0;o<this.markers.length;o++){var a=this.markers[o];if(a.touchInBounds(e.x,e.y)){e.dragHandle=a,this.currentDragTouches.push(e),a.setDrag(!0),e.dragHandle.offset.x=e.x-e.dragHandle.getPosition().x,e.dragHandle.offset.y=e.y-e.dragHandle.getPosition().y,this.dragCorner(e.x-e.dragHandle.offset.x,e.y-e.dragHandle.offset.y,e.dragHandle);break}}e.dragHandle==null&&this.center.touchInBounds(e.x,e.y)&&(e.dragHandle=this.center,this.currentDragTouches.push(e),e.dragHandle.setDrag(!0),e.dragHandle.offset.x=e.x-e.dragHandle.getPosition().x,e.dragHandle.offset.y=e.y-e.dragHandle.getPosition().y,this.dragCrop(e.x-e.dragHandle.offset.x,e.y-e.dragHandle.offset.y,e.dragHandle))}},t.prototype.updateClampBounds=function(){var e=this.srcImage.height/this.srcImage.width,t=this.canvas.height/this.canvas.width,n=this.canvas.width,r=this.canvas.height;t>e?(n=this.canvas.width,r=this.canvas.width*e):(r=this.canvas.height,n=this.canvas.height/e),this.minXClamp=this.canvas.width/2-n/2,this.minYClamp=this.canvas.height/2-r/2,this.maxXClamp=this.canvas.width/2+n/2,this.maxYClamp=this.canvas.height/2+r/2},t.prototype.getCropBounds=function(){var e=this.canvas.height-this.minYClamp*2,t=this.getBounds();return t.top=Math.round((e-t.top+this.minYClamp)/this.ratioH),t.bottom=Math.round((e-t.bottom+this.minYClamp)/this.ratioH),t.left=Math.round((t.left-this.minXClamp)/this.ratioW),t.right=Math.round((t.right-this.minXClamp)/this.ratioW),t},t.prototype.clampPosition=function(e,t){return e<this.minXClamp&&(e=this.minXClamp),e>this.maxXClamp&&(e=this.maxXClamp),t<this.minYClamp&&(t=this.minYClamp),t>this.maxYClamp&&(t=this.maxYClamp),u.instance.borrow(e,t)},t.prototype.isImageSet=function(){return this.imageSet},t.prototype.setImage=function(t){if(!t)throw"Image is null";this.imageSet=!0,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);var n=this.buffer.getContext("2d");n.clearRect(0,0,this.buffer.width,this.buffer.height);var i=t.src.split("."),s=i[1];s=s=="jpg"?"jpeg":s;if(s=="png"||s=="jpeg")this.fileType=s;this.srcImage=t,this.updateClampBounds();var o=this.srcImage.height/this.srcImage.width,a=this.getBounds(),f=a.getHeight()/a.getWidth(),l=this.canvas.width,h=this.canvas.height;this.canvasWidth=l,this.canvasHeight=h;var p=this.canvas.width/2,d=this.canvas.height/2,v=u.instance.borrow(p-a.getWidth()/2,d+a.getHeight()/2),m=u.instance.borrow(p+a.getWidth()/2,d+a.getHeight()/2),g=u.instance.borrow(p-a.getWidth()/2,d-a.getHeight()/2),y=u.instance.borrow(p+a.getWidth()/2,d-a.getHeight()/2);this.tl.setPosition(v.x,v.y),this.tr.setPosition(m.x,m.y),this.bl.setPosition(g.x,g.y),this.br.setPosition(y.x,y.y),u.instance.returnPoint(v),u.instance.returnPoint(m),u.instance.returnPoint(g),u.instance.returnPoint(y),this.center.setPosition(p,d);if(f>o){var b=Math.min(l*o,h),w=b/f;v=u.instance.borrow(p-w/2,d+b/2),m=u.instance.borrow(p+w/2,d+b/2),g=u.instance.borrow(p-w/2,d-b/2),y=u.instance.borrow(p+w/2,d-b/2)}else if(f<o){var E=Math.min(h/o,l),S=E*f;v=u.instance.borrow(p-E/2,d+S/2),m=u.instance.borrow(p+E/2,d+S/2),g=u.instance.borrow(p-E/2,d-S/2),y=u.instance.borrow(p+E/2,d-S/2)}else{var E=Math.min(h,l),S=E*f;v=u.instance.borrow(p-E/2,d+S/2),m=u.instance.borrow(p+E/2,d+S/2),g=u.instance.borrow(p-E/2,d-S/2),y=u.instance.borrow(p+E/2,d-S/2)}this.tl.setPosition(v.x,v.y),this.tr.setPosition(m.x,m.y),this.bl.setPosition(g.x,g.y),this.br.setPosition(y.x,y.y),u.instance.returnPoint(v),u.instance.returnPoint(m),u.instance.returnPoint(g),u.instance.returnPoint(y);if(e.cropAreaBounds&&e.cropAreaBounds.left!==undefined&&e.cropAreaBounds.top!==undefined&&e.cropAreaBounds.right!==undefined&&e.cropAreaBounds.bottom!==undefined){var x=this.canvasHeight/this.canvasWidth;x>o?(l=this.canvasWidth,h=this.canvasWidth*o):(h=this.canvasHeight,l=this.canvasHeight/o),this.ratioW=l/this.srcImage.width,this.ratioH=h/this.srcImage.height;var T=new c;T.top=Math.round(h+this.minYClamp-this.ratioH*e.cropAreaBounds.top),T.bottom=Math.round(h+this.minYClamp-this.ratioH*e.cropAreaBounds.bottom),T.left=Math.round(this.ratioW*e.cropAreaBounds.left+this.minXClamp),T.right=Math.round(this.ratioW*e.cropAreaBounds.right+this.minXClamp),this.tl.setPosition(T.left,T.top),this.tr.setPosition(T.right,T.top),this.bl.setPosition(T.left,T.bottom),this.br.setPosition(T.right,T.bottom),this.center.setPosition(T.left+T.getWidth()/2,T.top+T.getHeight()/2)}this.vertSquashRatio=this.detectVerticalSquash(this.srcImage),this.draw(this.ctx);var N=this.getCroppedImage(e.cropWidth,e.cropHeight);r.croppedImage!==undefined&&(e.croppedImage=N.src),e.cropAreaBounds&&this.imageSet&&(e.cropAreaBounds=this.getCropBounds())},t.prototype.getCroppedImage=function(e,t){var n=this.getBounds();if(!this.srcImage)throw"Source image not set.";if(e&&t){var r=this.srcImage.height/this.srcImage.width,i=this.canvas.height/this.canvas.width,s=this.canvas.width,o=this.canvas.height;i>r?(s=this.canvas.width,o=this.canvas.width*r):i<r?(o=this.canvas.height,s=this.canvas.height/r):(o=this.canvas.height,s=this.canvas.width),this.ratioW=s/this.srcImage.width,this.ratioH=o/this.srcImage.height,this.cropCanvas.width=e,this.cropCanvas.height=t;var u=(this.buffer.height-o)/2/this.ratioH,a=(this.buffer.width-s)/2/this.ratioW;this.drawImageIOSFix(this.cropCanvas.getContext("2d"),this.srcImage,Math.max(Math.round(n.left/this.ratioW-a),0),Math.max(Math.round(n.top/this.ratioH-u),0),Math.max(Math.round(n.getWidth()/this.ratioW),1),Math.max(Math.round(n.getHeight()/this.ratioH),1),0,0,e,t),this.croppedImage.width=e,this.croppedImage.height=t}else this.cropCanvas.width=Math.max(n.getWidth(),1),this.cropCanvas.height=Math.max(n.getHeight(),1),this.cropCanvas.getContext("2d").drawImage(this.buffer,n.left,n.top,Math.max(n.getWidth(),1),Math.max(n.getHeight(),1),0,0,n.getWidth(),n.getHeight()),this.croppedImage.width=this.cropCanvas.width,this.croppedImage.height=this.cropCanvas.height;return this.croppedImage.src=this.cropCanvas.toDataURL("image/"+this.fileType),this.croppedImage},t.prototype.getBounds=function(){var e=Number.MAX_VALUE,t=Number.MAX_VALUE,n=-Number.MAX_VALUE,r=-Number.MAX_VALUE;for(var i=0;i<this.markers.length;i++){var s=this.markers[i];s.getPosition().x<e&&(e=s.getPosition().x),s.getPosition().x>n&&(n=s.getPosition().x),s.getPosition().y<t&&(t=s.getPosition().y),s.getPosition().y>r&&(r=s.getPosition().y)}var o=new c;return o.left=e,o.right=n,o.top=t,o.bottom=r,o},t.prototype.setBounds=function(e){var t,n,r,i,s=this.getBounds();for(var o=0;o<this.markers.length;o++){var u=this.markers[o];u.getPosition().x==s.left?u.getPosition().y==s.top?t=u:r=u:u.getPosition().y==s.top?n=u:i=u}t.setPosition(e.left,e.top),n.setPosition(e.right,e.top),r.setPosition(e.left,e.bottom),i.setPosition(e.right,e.bottom),this.center.recalculatePosition(e),this.center.draw(this.ctx)},t.prototype.getMousePos=function(e,t){var n=e.getBoundingClientRect();return u.instance.borrow(t.clientX-n.left,t.clientY-n.top)},t.prototype.getTouchPos=function(e,t){var n=e.getBoundingClientRect();return u.instance.borrow(t.clientX-n.left,t.clientY-n.top)},t.prototype.onTouchMove=function(e){if(i.isImageSet()){e.preventDefault();if(e.touches.length>=1)for(var t=0;t<e.touches.length;t++){var n=e.touches[t],r=this.getTouchPos(this.canvas,n),s=new p(r.x,r.y,n.identifier);u.instance.returnPoint(r),this.move(s,e)}this.draw(this.ctx)}},t.prototype.onMouseMove=function(e){if(i.isImageSet()){var t=this.getMousePos(this.canvas,e);this.move(new p(t.x,t.y,0),e);var n=this.getDragTouchForID(0);n?(n.x=t.x,n.y=t.y):n=new p(t.x,t.y,0),u.instance.returnPoint(t),this.drawCursors(n,e),this.draw(this.ctx)}},t.prototype.move=function(e,t){this.isMouseDown&&this.handleMove(e)},t.prototype.getDragTouchForID=function(e){for(var t=0;t<this.currentDragTouches.length;t++)if(e==this.currentDragTouches[t].id)return this.currentDragTouches[t]},t.prototype.drawCursors=function(e,t){var r=!1;e!=null&&(e.dragHandle==this.center&&(n.setStyle(this.canvas,"move"),r=!0),e.dragHandle!=null&&e.dragHandle instanceof l&&(this.drawCornerCursor(e.dragHandle,e.dragHandle.getPosition().x,e.dragHandle.getPosition().y,t),r=!0));var i=!1;if(!r){for(var s=0;s<this.markers.length;s++)i=i||this.drawCornerCursor(this.markers[s],e.x,e.y,t);i||n.setStyle(this.canvas,"initial")}!i&&!r&&this.center.touchInBounds(e.x,e.y)?(this.center.setOver(!0),n.setOver(this.canvas),n.setStyle(this.canvas,"move")):this.center.setOver(!1)},t.prototype.drawCornerCursor=function(e,t,r,i){return e.touchInBounds(t,r)?(e.setOver(!0),e.getHorizontalNeighbour().getPosition().x>e.getPosition().x?e.getVerticalNeighbour().getPosition().y>e.getPosition().y?(n.setOver(this.canvas),n.setStyle(this.canvas,"nwse-resize")):(n.setOver(this.canvas),n.setStyle(this.canvas,"nesw-resize")):e.getVerticalNeighbour().getPosition().y>e.getPosition().y?(n.setOver(this.canvas),n.setStyle(this.canvas,"nesw-resize")):(n.setOver(this.canvas),n.setStyle(this.canvas,"nwse-resize")),!0):(e.setOver(!1),!1)},t.prototype.onTouchStart=function(e){i.isImageSet()&&(this.isMouseDown=!0)},t.prototype.onTouchEnd=function(t){if(i.isImageSet()){for(var n=0;n<t.changedTouches.length;n++){var s=t.changedTouches[n],o=this.getDragTouchForID(s.identifier);o!=null&&((o.dragHandle instanceof l||o.dragHandle instanceof f)&&o.dragHandle.setOver(!1),this.handleRelease(o))}if(i.isImageSet()&&this.currentlyInteracting){var u=this.getCroppedImage(e.cropWidth,e.cropHeight);r.croppedImage!==undefined&&(e.croppedImage=u.src),e.$apply()}this.currentDragTouches.length==0&&(this.isMouseDown=!1,this.currentlyInteracting=!1)}},t.prototype.drawImageIOSFix=function(e,t,n,r,i,s,o,u,a,f){e.drawImage(t,n*this.vertSquashRatio,r*this.vertSquashRatio,i*this.vertSquashRatio,s*this.vertSquashRatio,o,u,a,f)},t.prototype.detectVerticalSquash=function(e){var t=e.naturalWidth,n=e.naturalHeight,r=document.createElement("canvas");r.width=1,r.height=n;var i=r.getContext("2d");i.drawImage(e,0,0);var s=i.getImageData(0,0,1,n).data,o=0,u=n,a=n;while(a>o){var f=s[(a-1)*4+3];f===0?u=a:o=a,a=u+o>>1}var l=a/n;return l===0?1:l},t.prototype.onMouseDown=function(e){i.isImageSet()&&(this.isMouseDown=!0)},t.prototype.onMouseUp=function(t){if(i.isImageSet()){n.setReleased(this.canvas),this.isMouseDown=!1,this.handleRelease(new p(0,0,0));if(this.currentlyInteracting==1){var s=this.getCroppedImage(e.cropWidth,e.cropHeight);r.croppedImage!==undefined&&(e.croppedImage=s.src),e.$apply()}this.currentlyInteracting=!1}},t}();e.$watch("cropWidth",v),e.$watch("cropHeight",v),e.$watch("keepAspect",v),e.$watch("touchRadius",v),e.$watch("image",m)}}}]),angular.module("angular-img-cropper").directive("imgCropperFileread",["$timeout",function(e){return{scope:{image:"="},link:function(t,n){n.bind("change",function(n){var r=new FileReader;r.onload=function(n){e(function(){t.image=n.target.result},0)},n.target.files[0]&&r.readAsDataURL(n.target.files[0])})}}}]),angular.module("angular-img-cropper").directive("imgCropperFilereadCall",function(){return{scope:{control:"="},link:function(e){e.internalControl=e.control||{},e.internalControl.load=function(e){var t=angular.element(document.querySelector(e)),n=document.createEvent("MouseEvent");n.initEvent("click",!0,!1),t[0].dispatchEvent(n)}}}}),angular.module("angular-img-cropper").factory("imageCropperDataShare",function(){var e={},t,n;return e.setPressed=function(e){t=e},e.setReleased=function(e){e===t&&(t=undefined)},e.setOver=function(e){n=e},e.setStyle=function(e,r){t!==undefined?t===e&&angular.element(document.documentElement).css("cursor",r):e===n&&angular.element(document.documentElement).css("cursor",r)},e});